# Repository Guidelines

## Project Structure & Module Organization
- Root `CMakeLists.txt` wires the static library, console samples, shader tooling, and unit tests.
- Engine code lives under `engine/`: public headers in `engine/include/RTRMetalEngine`, implementation in `engine/src` grouped into `Core`, `Rendering`, and `Scene` bundles (the former `MPS` path now only hosts shared data helpers).
- Metal shader sources are in `shaders/`; build output `build/shaders/RTRShaders.metallib` is generated by the main CMake build.
- Configuration files reside in `config/`, runtime assets in `assets/`, and documentation in `docs/`.
- Deterministic regression tests sit in `tests/` and are registered with CTest.

## Build, Test, and Development Commands
- Configure: `cmake -S . -B build` (rerun after adding dependencies or toggling options).
- Debug build: `cmake --build build` (builds engine, samples, tests, and shaders).
- Run sample: `./build/RTRMetalSample --scene=cornell --frames=16` (accepts resolution/hash flags plus `--mode=auto|hardware`). Only the hardware backend is active; `auto` simply aliases hardware until the fallback returns in Stage 4.
- On-screen sample: `cmake --build build --target RTRMetalOnScreenSample && open build/RTRMetalOnScreenSample.app`.
- Test suite: `cd build && ctest --output-on-failure` (gathers GoogleTest binaries).

## Coding Style & Naming Conventions
- C++20, 4-space indentation; keep lines ≈120 chars and favor descriptive identifiers.
- Types use `UpperCamelCase`, functions/variables `lowerCamelCase`, constants `kPascalCase`.
- Mirror existing namespaces (`RTR`, `RTR::Rendering`) and prefer small, composable classes over inheritance.
- Use `metal`/`metallib` CLI via CMake; avoid ad hoc shader build scripts.
- Run clang-format with the project preset when available (`cmake --build build --target format`).

## Development Philosophy
- Align feature work with Apple’s official Metal ray tracing samples (`~/Desktop/metal_RTR_official_example`) and the vetted open-source fallback (`~/Desktop/MetalRayTracing`) for reference, but ship hardware parity before resurrecting the fallback path (now deferred).
- Prioritise stability over experimentation: disable speculative paths (e.g., GPU virtual addresses) until they are proven on Apple hardware and documented by Apple.
- When in doubt, replicate the resource binding, buffer upload, and command-encoder patterns demonstrated in the reference samples before adding custom abstractions.

## Testing Guidelines
- Add new coverage in `tests/` alongside the relevant module; prefer focused `*_tests.cpp` fixtures.
- Structure tests as Given/When/Then and keep them deterministic (no GPU device assumptions).
- Validate buffer math, scene packing, and configuration parsing; mock device handles instead of hitting Metal APIs.
- Run `ctest` locally before pushing and after changing build flags or shader interfaces.

## Commit & Pull Request Guidelines
- Write imperative commit subjects ≤72 characters (e.g., `Add TLAS allocator sizing helper`).
- Reference affected stage in `IMPLEMENTATION_PLAN.md` when applicable and update the plan in the same change.
- PR descriptions summarize functional impact, list `cmake --build`/`ctest` results, and link issues or ADRs.
- Include screenshots or frame dumps when sample output changes, and note required GPU capabilities.
- Reject partial builds: every commit must compile, pass tests, and maintain shader compatibility.
